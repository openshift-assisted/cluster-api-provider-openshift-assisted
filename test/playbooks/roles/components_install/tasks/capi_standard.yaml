---
- name: Prepare infrastructure-operator
  delegate_to: localhost
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../../test/e2e/manifests/infrastructure-operator/kustomization.yaml.j2"
    dest: "{{ playbook_dir }}/../../test/e2e/manifests/infrastructure-operator/kustomization.yaml"
    mode: '0644'
  vars:
    assisted_service_image: >-
      {{ lookup('ansible.builtin.env',
      'ASSISTED_SERVICE_IMAGE', default=default_assisted_service_image) }}
    infrastructure_operator_image: >-
      {{ lookup('ansible.builtin.env',
      'INFRASTRUCTURE_OPERATOR_IMAGE',
      default=default_infrastructure_operator_image) }}
    assisted_installer_agent_image: >-
      {{ lookup('ansible.builtin.env',
      'ASSISTED_INSTALLER_AGENT_IMAGE',
      default=default_assisted_installer_agent_image) }}
    assisted_installer_controller_image: >-
      {{ lookup('ansible.builtin.env',
      'ASSISTED_INSTALLER_CONTROLLER_IMAGE',
      default=default_assisted_installer_controller_image) }}
    assisted_installer_image: >-
      {{ lookup('ansible.builtin.env',
      'ASSISTED_INSTALLER_IMAGE',
      default=default_assisted_installer_image) }}
    infrastructure_operator_version: >-
      {{ lookup('ansible.builtin.env',
      'INFRASTRUCTURE_OPERATOR_VERSION',
      default=default_infrastructure_operator_version) }}
    assisted_service_version: >-
      {{ lookup('ansible.builtin.env',
      'ASSISTED_SERVICE_VERSION',
      default=default_assisted_service_version) }}
    assisted_installer_agent_version: >-
      {{ lookup('ansible.builtin.env',
      'ASSISTED_INSTALLER_AGENT_VERSION',
      default=default_assisted_installer_agent_version) }}
    assisted_installer_controller_version: >-
      {{ lookup('ansible.builtin.env',
      'ASSISTED_INSTALLER_CONTROLLER_VERSION',
      default=default_assisted_installer_controller_version) }}
    assisted_installer_version: >-
      {{ lookup('ansible.builtin.env',
      'ASSISTED_INSTALLER_VERSION',
      default=default_assisted_installer_version) }}

- name: Deploy infrastructure operator
  kubernetes.core.k8s:
    definition: "{{ lookup('kubernetes.core.kustomize', dir=playbook_dir + '/../../test/e2e/manifests/infrastructure-operator') }}"
    state: present
    apply: true


- name: Deploy agent service config
  kubernetes.core.k8s:
    state: present
    src: "{{ src_dir }}/test/e2e/manifests/infrastructure-operator/agentconfig.yaml"

- name: Wait for assisted-service
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: assisted-service
    namespace: assisted-installer
  register: assisted_service_status
  until: >-
    assisted_service_status.resources is defined and
    assisted_service_status.resources | length > 0 and
    assisted_service_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list |
    length > 0
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Install clusterctl
  ansible.builtin.get_url:
    url: "https://github.com/kubernetes-sigs/cluster-api/releases/download/{{ capi_version }}/clusterctl-linux-amd64"
    dest: /usr/local/bin/clusterctl
    mode: '0755'

- name: Deploy CAPI
  ansible.builtin.command: "clusterctl init --core cluster-api:{{ capi_version }} --bootstrap - --control-plane - --infrastructure metal3:{{ capm3_version }}"
  changed_when: true

- name: Deploy CAPBOA
  kubernetes.core.k8s:
    definition: "{{ lookup('kubernetes.core.kustomize', dir=playbook_dir + '/../../test/e2e/manifests/capboa') }}"
    state: present
    apply: true

- name: Deploy CAPCOA
  kubernetes.core.k8s:
    definition: "{{ lookup('kubernetes.core.kustomize', dir=playbook_dir + '/../../test/e2e/manifests/capcoa') }}"
    state: present
    apply: true

