---
# Setup and run tests playbook
#
# Environment variables for conditional execution:
#   SKIP_BUILD=true        - Skip building provider images
#   SKIP_CAPI_INSTALL=true - Skip CAPI/MCE component installation (dependencies still installed)
#   SKIP_CLUSTER=true      - Skip cluster manifest application and assertions
#
# Examples:
#   # Full test run (default)
#   ansible-playbook -i inventories/local_host.yaml run_test.yaml
#
#   # Skip image build (use pre-built images)
#   SKIP_BUILD=true ansible-playbook -i inventories/local_host.yaml run_test.yaml
#
#   # Demo mode: setup everything for manual MCE deployment and cluster provisioning
#   # (infra, dependencies, BMH setup - but skip CAPI install and cluster provisioning)
#   SKIP_BUILD=true SKIP_CAPI_INSTALL=true SKIP_CLUSTER=true ansible-playbook -i inventories/local_host.yaml run_test.yaml
#
#   # Deploy components but skip cluster provisioning
#   SKIP_CLUSTER=true ansible-playbook -i inventories/local_host.yaml run_test.yaml

- name: Setup and run tests
  hosts: test_runner
  vars:
    cert_manager_version: v1.5.3
    remote_manifests_path: /tmp/manifests
    test_namespace: test-capi
    number_of_nodes: "{{ lookup('ansible.builtin.env', 'NUMBER_OF_NODES', default='7') }}"
    cluster_topology: "{{ lookup('ansible.builtin.env', 'CLUSTER_TOPOLOGY', default='multinode') }}"
    example_manifest: "{{ cluster_topology }}-example.yaml.j2"
    default_assisted_service_image: "quay.io/edge-infrastructure/assisted-service"
    default_infrastructure_operator_image: "quay.io/edge-infrastructure/assisted-service"
    default_assisted_installer_agent_image: "quay.io/edge-infrastructure/assisted-installer-agent"
    default_assisted_installer_controller_image: "quay.io/edge-infrastructure/assisted-installer-controller"
    default_assisted_installer_image: "quay.io/edge-infrastructure/assisted-installer"
    default_assisted_installer_agent_version: "sha256:58732e1b4c26d5d4c8c0a662c82e388c02684800925f4b4db4447dce8010bf14"
    default_assisted_installer_controller_version: "sha256:d4755a824f92c211df890ff8e65523d085dcbd393aeeb314ff5a024eb5418257"
    default_infrastructure_operator_version: "sha256:c82660f92842d99fdd12507c0c61a39bfc25f04e71b5ab69c265fb749be3518c"
    default_assisted_installer_version: "sha256:c31f3f58d0776edd6726f44858f93a95dcb8e179706297d263e32291a854df54"
    default_assisted_service_version: "sha256:c82660f92842d99fdd12507c0c61a39bfc25f04e71b5ab69c265fb749be3518c"
    capi_version: "{{ lookup('ansible.builtin.env', 'CAPI_VERSION', default='v1.11.3') }}"
    capm3_version: "{{ lookup('ansible.builtin.env', 'CAPM3_VERSION', default='v1.11.2') }}"
    dist_dir: "{{ lookup('ansible.builtin.env', 'DIST_DIR') }}"
    src_dir: "/tmp/capbcoa"
    kind_cluster_name: capi-baremetal-provider
    kind_network_prefix: "{{ lookup('ansible.builtin.env', 'KIND_NETWORK_PREFIX', default='10.89.0') }}"
    kubectl_version: "{{ lookup('ansible.builtin.env', 'KUBECTL_VERSION', default='v1.31.4') }}"
    ssh_authorized_key: "{{ lookup('ansible.builtin.env', 'SSH_AUTHORIZED_KEY') }}"
    pullsecret: "{{ lookup('ansible.builtin.env', 'PULLSECRET') }}"
    container_tag: "{{ lookup('ansible.builtin.env', 'CONTAINER_TAG', default='local')}}"
    cluster_name: "test-{{cluster_topology}}"
    medium_delay: 10
    medium_retries: 60
    high_delay: 60
    high_retries: 300
    low_delay: 1
    low_retries: 1
    extra_paths:
      - /usr/local/bin
    openshift_version: "4.20.0"
    rhcos_image_url: "https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.20/4.20.0/rhcos-4.20.0-x86_64-nutanix.x86_64.qcow2"
    rhcos_checksum_url: https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.20/4.20.0/sha256sum.txt
    # Conditional execution flags
    skip_build: "{{ lookup('ansible.builtin.env', 'SKIP_BUILD', default='false') | lower in ['true', '1', 'yes'] }}"
    skip_capi_install: "{{ lookup('ansible.builtin.env', 'SKIP_CAPI_INSTALL', default='false') | lower in ['true', '1', 'yes'] }}"
    skip_cluster: "{{ lookup('ansible.builtin.env', 'SKIP_CLUSTER', default='false') | lower in ['true', '1', 'yes'] }}"
  environment:
    PATH: "{{ extra_paths | join(':') }}:{{ ansible_env.PATH }}"
  roles:
    # Infrastructure setup (always runs)
    - system_dependencies
    - sourcecode_setup
    - network_setup
    - baremetal_emulation
    - kind_setup
    # Build provider images (skip if skip_build)
    - role: build_images
      when: not skip_build
    # Components install - always runs, but respects skip_capi_install internally
    # Always installs dependencies (cert-manager, prometheus, ironic, BMO, MetalLB, nginx)
    # Skips CAPI/MCE components if skip_capi_install=true
    - components_install
    # BMH setup (always runs - needed for demo and full test)
    - bmh_setup
    # Cluster provisioning (skip if skip_cluster)
    - role: cluster_install
      when: not skip_cluster
    - role: assert_install
      when: not skip_cluster
    - role: assert_upgrade
      when: not skip_cluster and upgrade_to_version is defined
