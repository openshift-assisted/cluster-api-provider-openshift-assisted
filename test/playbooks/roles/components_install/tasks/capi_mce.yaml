---
# MCE-based CAPI installation
# Installs: InfrastructureOperator, CAPI, CAPOA, CAPM3 via MCE Helm chart
#
# Prerequisites (installed by common.yaml):
# - cert-manager
# - kube-prometheus-stack
# - helm

- name: Try to get GitHub token from gh CLI on localhost
  ansible.builtin.command: gh auth token
  delegate_to: localhost
  register: gh_token_result
  failed_when: false
  changed_when: false
  when: github_token == '' and installation_mode == 'upstream'

- name: Set effective GitHub token
  ansible.builtin.set_fact:
    effective_github_token: "{{ github_token if github_token != '' else (gh_token_result.stdout | default('')) | trim }}"
  when: installation_mode == 'upstream'

- name: Debug GitHub token status
  ansible.builtin.debug:
    msg: "GitHub token available: {{ 'yes' if effective_github_token != '' else 'no' }}"
  when: installation_mode == 'upstream'

- name: Select manifest URL based on mode
  ansible.builtin.set_fact:
    mce_image_manifest_url: "{{ mce_manifest_url_upstream if installation_mode == 'upstream' else mce_manifest_url_downstream }}"

- name: Fetch MCE image manifest (upstream with token)
  ansible.builtin.uri:
    url: "{{ mce_image_manifest_url }}"
    headers:
      Authorization: "token {{ effective_github_token }}"
    return_content: true
  register: mce_manifest_upstream
  when: installation_mode == 'upstream' and effective_github_token | default('') != ''

- name: Fetch MCE image manifest (downstream or upstream public)
  ansible.builtin.uri:
    url: "{{ mce_image_manifest_url }}"
    return_content: true
  register: mce_manifest_downstream
  when: installation_mode == 'downstream' or (installation_mode == 'upstream' and effective_github_token | default('') == '')

- name: Parse image manifest
  ansible.builtin.set_fact:
    mce_images: "{{ (mce_manifest_upstream.content if mce_manifest_upstream.content is defined else mce_manifest_downstream.content) | from_json }}"

- name: Clone MCE Helm chart repository
  ansible.builtin.git:
    repo: "{{ mce_chart_repo }}"
    dest: /tmp/mce-operator-helm-xks
    version: "{{ mce_chart_branch }}"
    force: true

- name: Generate MCE values file
  ansible.builtin.template:
    src: mce-values.yaml.j2
    dest: /tmp/mce-values.yaml
    mode: '0644'

- name: Show generated values file
  ansible.builtin.command: cat /tmp/mce-values.yaml
  register: values_content
  changed_when: false

- name: Debug values file content
  ansible.builtin.debug:
    msg: "{{ values_content.stdout_lines }}"

- name: Create MCE namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ mce_namespace }}"
    state: present

- name: Install MCE CRDs
  ansible.builtin.shell: |
    set -o pipefail
    helm show crds {{ mce_chart_path }} | kubectl apply -f -
  changed_when: true

- name: Install MCE chart via helm template
  ansible.builtin.shell: |
    set -o pipefail
    helm template mce --namespace {{ mce_namespace }} \
      --values /tmp/mce-values.yaml \
      {{ mce_chart_path }} | kubectl -n {{ mce_namespace }} apply -f -
  changed_when: true

- name: Deploy MultiClusterEngine CR
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: multicluster.openshift.io/v1
      kind: MultiClusterEngine
      metadata:
        name: multiclusterengine
        namespace: "{{ mce_namespace }}"
      spec:
        imagePullSecret: open-cluster-management-image-pull-credentials
        overrides:
          components:
            - name: assisted-service
              enabled: true
              configOverrides: {}
            - name: cluster-api
              enabled: "{{ not capi_standalone }}"
              configOverrides: {}
            - name: cluster-api-provider-metal3-preview
              enabled: "{{ not capm3_standalone }}"
              configOverrides: {}
            - name: cluster-api-provider-openshift-assisted-preview
              enabled: true
              configOverrides: {}
            - name: cluster-manager
              enabled: true
              configOverrides: {}
            - name: cluster-lifecycle
              enabled: false
              configOverrides: {}
            - name: server-foundation
              enabled: false
              configOverrides: {}
            - name: local-cluster
              enabled: false
              configOverrides: {}
            - name: console-mce
              enabled: false
              configOverrides: {}
            - name: hypershift
              enabled: false
              configOverrides: {}
            - name: hypershift-local-hosting
              enabled: false
              configOverrides: {}
            - name: discovery
              enabled: false
              configOverrides: {}
            - name: hive
              enabled: false
              configOverrides: {}
            - name: cluster-proxy-addon
              enabled: false
              configOverrides: {}
            - name: managedserviceaccount
              enabled: false
              configOverrides: {}
            - name: cluster-api-provider-aws
              enabled: false
              configOverrides: {}
            - name: image-based-install-operator
              enabled: false
              configOverrides: {}
        targetNamespace: "{{ mce_namespace }}"

- name: Wait for MCE operator
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: multicluster-engine-operator
    namespace: "{{ mce_namespace }}"
  register: mce_operator_status
  until: >-
    mce_operator_status.resources is defined and
    mce_operator_status.resources | length > 0 and
    mce_operator_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list |
    length > 0
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Wait for AgentServiceConfig CRD to be available
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: agentserviceconfigs.agent-install.openshift.io
  register: asc_crd_status
  until: >-
    asc_crd_status.resources is defined and
    asc_crd_status.resources | length > 0
  retries: "{{ high_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Generate MCE agent service config
  ansible.builtin.template:
    src: mce-agentconfig.yaml.j2
    dest: /tmp/mce-agentconfig.yaml
    mode: '0644'

- name: Deploy agent service config for MCE
  kubernetes.core.k8s:
    state: present
    src: /tmp/mce-agentconfig.yaml

- name: Wait for assisted-service (MCE namespace)
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: assisted-service
    namespace: "{{ mce_namespace }}"
  register: assisted_service_status
  until: >-
    assisted_service_status.resources is defined and
    assisted_service_status.resources | length > 0 and
    assisted_service_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list |
    length > 0
  retries: "{{ high_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Wait for CAPI controller (MCE)
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ mce_namespace }}"
    label_selectors:
      - "cluster.x-k8s.io/provider=cluster-api"
  register: capi_status
  until: >-
    capi_status.resources is defined and
    capi_status.resources | length > 0 and
    capi_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list |
    length > 0
  retries: "{{ high_retries | int }}"
  delay: "{{ medium_delay | int }}"
  when: not capi_standalone

# Standalone CAPI/CAPM3 installation (when not using MCE for these components)
# This happens AFTER MCE is fully deployed and reconciled

- name: Install clusterctl for standalone components
  ansible.builtin.get_url:
    url: "https://github.com/kubernetes-sigs/cluster-api/releases/download/{{ capi_version }}/clusterctl-linux-amd64"
    dest: /usr/local/bin/clusterctl
    mode: '0755'
  when: capi_standalone or capm3_standalone

- name: Wait for MCE to fully stabilize before standalone installation
  ansible.builtin.pause:
    seconds: 30
    prompt: "Waiting for MCE to fully stabilize before standalone CAPI/CAPM3 installation..."
  when: capi_standalone or capm3_standalone

- name: Check for MCE-installed CAPI CRDs
  ansible.builtin.command: kubectl get crds -o name
  register: all_crds
  changed_when: false
  when: capi_standalone or capm3_standalone

- name: Debug existing CAPI CRDs
  ansible.builtin.debug:
    msg: "Existing CAPI CRDs: {{ all_crds.stdout_lines | select('search', 'cluster.x-k8s.io') | list }}"
  when: capi_standalone or capm3_standalone

# Standalone CAPI/CAPM3 installation using kustomize to rename ALL resources
# This prevents MCE from removing resources it thinks it should control

- name: Set manifests path (use /tmp for remote execution)
  ansible.builtin.set_fact:
    capi_manifests_path: "/tmp/capi-standalone"
    capm3_manifests_path: "/tmp/capm3-standalone"
  when: capi_standalone or capm3_standalone

- name: Ensure CAPI standalone manifests directory exists
  ansible.builtin.file:
    path: "{{ capi_manifests_path }}"
    state: directory
    mode: '0755'
  when: capi_standalone

- name: Copy CAPI kustomization files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ capi_manifests_path }}/"
    mode: '0644'
  loop:
    - capi-standalone/kustomization.yaml
    - capi-standalone/name-reference-config.yaml
  when: capi_standalone

- name: Ensure CAPM3 standalone manifests directory exists
  ansible.builtin.file:
    path: "{{ capm3_manifests_path }}"
    state: directory
    mode: '0755'
  when: capm3_standalone

- name: Copy CAPM3 kustomization files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ capm3_manifests_path }}/"
    mode: '0644'
  loop:
    - capm3-standalone/kustomization.yaml
    - capm3-standalone/name-reference-config.yaml
  when: capm3_standalone

- name: Generate CAPI base manifests from clusterctl
  ansible.builtin.shell: |
    set -o pipefail
    clusterctl generate provider --core cluster-api:{{ capi_version }} > {{ capi_manifests_path }}/base-manifests.yaml
  changed_when: true
  when: capi_standalone

- name: Create capi-standalone namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: capi-standalone
    state: present
  when: capi_standalone

- name: Apply standalone CAPI via kustomize (all resources renamed)
  ansible.builtin.shell: |
    set -o pipefail
    kubectl apply --server-side --force-conflicts -k {{ capi_manifests_path }}/
  changed_when: true
  when: capi_standalone

- name: Generate CAPM3 base manifests from clusterctl
  ansible.builtin.shell: |
    set -o pipefail
    clusterctl generate provider --infrastructure metal3:{{ capm3_version }} > {{ capm3_manifests_path }}/base-manifests.yaml
  changed_when: true
  when: capm3_standalone

- name: Create capm3-standalone namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: capm3-standalone
    state: present
  when: capm3_standalone

- name: Apply standalone CAPM3 via kustomize (all resources renamed)
  ansible.builtin.shell: |
    set -o pipefail
    kubectl apply --server-side --force-conflicts -k {{ capm3_manifests_path }}/
  changed_when: true
  when: capm3_standalone

- name: Wait for standalone CAPI controller
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: standalone-capi-controller-manager
    namespace: capi-standalone
  register: capi_standalone_status
  until: >-
    capi_standalone_status.resources is defined and
    capi_standalone_status.resources | length > 0 and
    capi_standalone_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list |
    length > 0
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"
  when: capi_standalone

- name: Wait for standalone CAPM3 controller
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: standalone-capm3-controller-manager
    namespace: capm3-standalone
  register: capm3_standalone_status
  until: >-
    capm3_standalone_status.resources is defined and
    capm3_standalone_status.resources | length > 0 and
    capm3_standalone_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list |
    length > 0
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"
  when: capm3_standalone
