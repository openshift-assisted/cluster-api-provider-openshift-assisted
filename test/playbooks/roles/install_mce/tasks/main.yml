---
- name: Add prometheus-community helm repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: https://prometheus-community.github.io/helm-charts

- name: Install kube-prometheus helm chart
  kubernetes.core.helm:
    name: kube-prometheus
    chart_ref: prometheus-community/kube-prometheus-stack
    release_namespace: monitoring
    create_namespace: true
    update_repo_cache: true
    state: present
    wait: true
    values:
      prometheus:
        prometheusSpec:
          maximumStartupDurationSeconds: 300

- name: Create staging dir
  ansible.builtin.tempfile:
    path: /tmp
    prefix: "install_mce_"
    state: directory
  register: install_mce_tempdir

- name: Clone multicluster-engine helm chart
  ansible.builtin.git:
    repo: "https://{{ mce_git_repo }}"
    version: "{{ mce_git_branch }}"
    dest: "{{ install_mce_tempdir['path'] }}"

- name: Copy values-override.yaml
  ansible.builtin.copy:
    src: "values-override.yaml"
    dest: "{{ install_mce_tempdir['path'] }}/charts/multicluster-engine/"

- set_fact:
    mce_external_components:
    - cluster-api
    - cluster-api-provider-metal3

- name: Install multicluster-engine helm chart
  kubernetes.core.helm:
    name: multicluster-engine
    chart_ref: "{{ install_mce_tempdir['path'] }}/charts/multicluster-engine"
    release_namespace: "{{ mce_namespace }}"
    create_namespace: true
    state: present
    wait: true
    values_files:
      - "{{ install_mce_tempdir['path'] }}/charts/multicluster-engine/values.yaml"
      - "{{ install_mce_tempdir['path'] }}/charts/multicluster-engine/values-override.yaml"
    values:
      pull_secret: "{{ pullsecret | to_json | b64encode }}"
      external_components: "{{ mce_external_components }}"
      components:
        assisted_service: true
        cluster_api: false 
        cluster_api_provider_metal3: false
        cluster_api_provider_openshift_assisted: true

- name: Apply AgentServiceConfig
  kubernetes.core.k8s:
    template: agentconfig.yaml.j2
    state: present
