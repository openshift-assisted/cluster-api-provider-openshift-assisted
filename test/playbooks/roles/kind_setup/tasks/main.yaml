---
- name: Check if kind exists and get version
  ansible.builtin.shell: |
    set -o pipefail
    kind version 2>/dev/null | awk '{ print $2}'
  register: kind_version_check
  changed_when: false
  failed_when: false

- name: Kind version
  ansible.builtin.debug:
    msg: "{{ kind_version_check.stdout }}"

- name: Download and install kind binary
  ansible.builtin.get_url:
    url: "https://kind.sigs.k8s.io/dl/{{ kind_setup_kind_version }}/kind-linux-amd64"
    dest: /usr/local/bin/kind
    mode: '0755'
  when: >
    kind_version_check.stdout is not defined or
    kind_version_check.stdout | length == 0 or
    kind_setup_kind_version not in kind_version_check.stdout

- name: Delete existing kind cluster
  ansible.builtin.command: kind delete cluster --name {{ kind_cluster_name }}
  changed_when: true
  failed_when: false

- name: Remove existing kind network
  ansible.builtin.command: podman network rm kind
  changed_when: true
  failed_when: false

- name: Create kind network with specific subnet
  ansible.builtin.command:
    argv:
      - podman
      - network
      - create
      - kind
      - --subnet
      - "{{ kind_network_prefix }}.0/24"
      - --gateway
      - "{{ kind_network_prefix }}.1"
      - --opt
      - mtu=1400
  changed_when: true

- name: Create kind cluster
  ansible.builtin.shell: |
    set -o pipefail
    export INTERNAL_IP={{ internal_ip }} && \
    cat {{ src_dir }}/test/kind.yaml | \
    sed "s/<DEVICE_IP>/${INTERNAL_IP}/g" > /tmp/kind_with_ip.yaml && \
    kind create cluster --name {{ kind_cluster_name }} --config /tmp/kind_with_ip.yaml
  changed_when: true

- name: Get latest kubectl version if not specified  # noqa: command-instead-of-module
  ansible.builtin.command: >
    curl -4 -sL --fail --retry 5 --retry-delay 5 --max-time 30
    https://dl.k8s.io/release/stable.txt
  register: stable_version
  changed_when: false
  failed_when: stable_version.rc != 0 or not stable_version.stdout is regex('^v[0-9]+\.[0-9]+\.[0-9]+')
  when: kubectl_version is not defined

- name: Set kubectl version
  ansible.builtin.set_fact:
    kubectl_version: "{{ kubectl_version | default(stable_version.stdout | trim) }}"

- name: Check if kubectl exists and get version
  ansible.builtin.shell: |
    set -o pipefail
    kubectl version 2>/dev/null | grep 'Client Version:' | sed 's/Client Version: //g'
  register: kubectl_version_check
  changed_when: false
  failed_when: false

- name: Kubectl version
  ansible.builtin.debug:
    msg: "{{ kubectl_version_check.stdout }}"
- name: Install kubectl binary
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
    dest: /usr/local/bin/kubectl
    mode: '0755'
  when: >
    kubectl_version_check.stdout is not defined or
    kubectl_version_check.stdout | length == 0 or
    kubectl_version not in kubectl_version_check.stdout
