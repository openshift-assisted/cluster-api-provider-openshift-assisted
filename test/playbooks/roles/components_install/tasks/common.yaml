---
- name: Deploy cert-manager
  kubernetes.core.k8s:
    state: present
    src: https://github.com/jetstack/cert-manager/releases/download/{{ cert_manager_version }}/cert-manager.yaml

- name: Wait for cert-manager
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: cert-manager-webhook
    namespace: cert-manager
  register: cert_manager_status
  until: >-
    cert_manager_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list | length > 0
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Show PATH
  ansible.builtin.debug:
    msg: "PATH: {{ ansible_env.PATH }}"

- name: Deploy ironic
  kubernetes.core.k8s:
    definition: "{{ lookup('kubernetes.core.kustomize', dir=playbook_dir + '/../../test/e2e/manifests/ironic') }}"
    state: present
    apply: true

- name: Wait for ironic
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: ironic
    namespace: baremetal-operator-system
  register: ironic_status
  until: >-
    ironic_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list | length > 0
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Deploy BMO
  kubernetes.core.k8s:
    definition: "{{ lookup('kubernetes.core.kustomize', dir=playbook_dir + '/../../test/e2e/manifests/bmo') }}"
    state: present
    apply: true

- name: Wait for BMO
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: baremetal-operator-controller-manager
    namespace: baremetal-operator-system
  register: bmo_status
  until: >-
    bmo_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list | length > 0
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Deploy MetalLB
  kubernetes.core.k8s:
    state: present
    src: https://raw.githubusercontent.com/metallb/metallb/v0.13.7/config/manifests/metallb-native.yaml

- name: Wait for MetalLB
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: controller
    namespace: metallb-system
  register: metallb_status
  until: >-
    metallb_status.resources[0].status.conditions |
    selectattr('type', 'equalto', 'Available') |
    selectattr('status', 'equalto', 'True') |
    list | length > 0
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Deploy metallb IPAddressPool
  kubernetes.core.k8s:
    definition: "{{ lookup('template', playbook_dir ~ '/../../test/e2e/manifests/metallb/metallb.yaml.j2') }}"
    state: present
    apply: true

- name: Create nginx-ingress namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: nginx-ingress
    state: present

- name: Deploy nginx-ingress
  kubernetes.core.k8s:
    state: present
    src: "{{ src_dir }}/test/e2e/manifests/ingress-nginx/nginx.yaml"
    apply: true

- name: Wait for load balancer IP
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: ingress-nginx-controller
    namespace: nginx-ingress
  register: lb_status
  until: lb_status.resources[0].status.loadBalancer.ingress is defined
  retries: "{{ medium_retries | int }}"
  delay: "{{ medium_delay | int }}"

- name: Save load balancer IP
  ansible.builtin.copy:
    content: "{{ lb_status.resources[0].status.loadBalancer.ingress[0].ip }}"
    dest: /tmp/loadbalancer_ip
    mode: '0644'

